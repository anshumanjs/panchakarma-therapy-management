<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Detail - PanchakarmaPro</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-leaf"></i>
                <span>PanchakarmaPro</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="patient-dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="patient-detail.html" class="nav-link active">Patient Detail</a></li>
                <li><a href="patient-report-dashboard.html" class="nav-link">Reports</a></li>
                <li><a href="feedback.html" class="nav-link">Feedback</a></li>
                <li><a href="gallery.html" class="nav-link">Gallery</a></li>
                <li><a href="#" class="nav-link" onclick="window.authGuard.confirmLogout()">Logout</a></li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Patient Detail Header -->
    <section class="patient-detail-header">
        <div class="container">
            <div class="patient-info-card">
                <div class="patient-avatar">
                    <img src="https://images.unsplash.com/photo-1494790108755-2616b612b786?ixlib=rb-4.0.3&auto=format&fit=crop&w=150&q=80" alt="Patient Avatar" id="patientAvatar">
                </div>
                <div class="patient-basic-info">
                    <h1 id="patientName">Sarah Johnson</h1>
                    <p class="patient-id">Patient ID: <span id="patientId">P001234</span></p>
                    <p class="patient-age">Age: <span id="patientAge">32</span> years</p>
                    <p class="patient-gender">Gender: <span id="patientGender">Female</span></p>
                    <div class="patient-status">
                        <span class="status-badge active">Active Patient</span>
                        <span class="last-visit">Last Visit: <span id="lastVisit">Dec 15, 2024</span></span>
                    </div>
                </div>
                <div class="patient-actions">
                    <button class="btn btn-outline" onclick="editPatientInfo()">
                        <i class="fas fa-edit"></i>
                        Edit Info
                    </button>
                    <button class="btn btn-primary" onclick="addNewProblem()">
                        <i class="fas fa-plus"></i>
                        Add Problem
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Patient Detail Content -->
    <section class="patient-detail-content">
        <div class="container">
            <div class="detail-tabs">
                <button class="tab-btn active" data-tab="overview">Overview</button>
                <button class="tab-btn" data-tab="problems">Problems & Issues</button>
                <button class="tab-btn" data-tab="improvements">Improvements</button>
                <button class="tab-btn" data-tab="vitals">Vital Signs</button>
                <button class="tab-btn" data-tab="therapy">Therapy Plan</button>
                <button class="tab-btn" data-tab="notes">Notes</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="overview">
                <div class="overview-grid">
                    <div class="overview-card">
                        <h3>Current Problems</h3>
                        <div class="problem-summary">
                            <div class="problem-item">
                                <span class="problem-title">Chronic Back Pain</span>
                                <span class="problem-severity severe">Severe</span>
                            </div>
                            <div class="problem-item">
                                <span class="problem-title">Digestive Issues</span>
                                <span class="problem-severity moderate">Moderate</span>
                            </div>
                            <div class="problem-item">
                                <span class="problem-title">Sleep Disturbance</span>
                                <span class="problem-severity mild">Mild</span>
                            </div>
                        </div>
                    </div>

                    <div class="overview-card">
                        <h3>Recent Improvements</h3>
                        <div class="improvement-summary">
                            <div class="improvement-item">
                                <span class="improvement-title">Pain Reduction</span>
                                <div class="improvement-bar">
                                    <div class="improvement-fill" style="width: 75%"></div>
                                </div>
                                <span class="improvement-percentage">75%</span>
                            </div>
                            <div class="improvement-item">
                                <span class="improvement-title">Sleep Quality</span>
                                <div class="improvement-bar">
                                    <div class="improvement-fill" style="width: 60%"></div>
                                </div>
                                <span class="improvement-percentage">60%</span>
                            </div>
                            <div class="improvement-item">
                                <span class="improvement-title">Energy Levels</span>
                                <div class="improvement-bar">
                                    <div class="improvement-fill" style="width: 85%"></div>
                                </div>
                                <span class="improvement-percentage">85%</span>
                            </div>
                        </div>
                    </div>

                    <div class="overview-card">
                        <h3>Dosha Assessment</h3>
                        <div class="dosha-chart">
                            <canvas id="doshaChart"></canvas>
                        </div>
                    </div>

                    <div class="overview-card">
                        <h3>Vital Signs Trend</h3>
                        <div class="vitals-chart">
                            <canvas id="vitalsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Problems Tab -->
            <div class="tab-content" id="problems">
                <div class="problems-header">
                    <h3>Current Problems & Issues</h3>
                    <button class="btn btn-primary" onclick="addNewProblem()">
                        <i class="fas fa-plus"></i>
                        Add New Problem
                    </button>
                </div>
                <div class="problems-list">
                    <div class="problem-card">
                        <div class="problem-header">
                            <h4>Chronic Back Pain</h4>
                            <div class="problem-meta">
                                <span class="severity severe">Severe</span>
                                <span class="status active">Active</span>
                                <span class="date">Reported: Dec 1, 2024</span>
                            </div>
                        </div>
                        <div class="problem-description">
                            <p>Lower back pain persisting for 6 months, affecting daily activities and sleep quality. Pain is worse in the morning and after prolonged sitting.</p>
                        </div>
                        <div class="problem-notes">
                            <h5>Practitioner Notes:</h5>
                            <div class="note-item">
                                <p><strong>Dr. Rajesh Kumar - Dec 15, 2024:</strong> Patient shows significant improvement with Basti therapy. Pain scale reduced from 8/10 to 5/10. Continue current treatment plan.</p>
                            </div>
                            <div class="note-item">
                                <p><strong>Dr. Priya Sharma - Dec 10, 2024:</strong> Initial assessment completed. Vata imbalance identified as primary cause. Recommended Virechana therapy.</p>
                            </div>
                        </div>
                        <div class="problem-actions">
                            <button class="btn btn-outline" onclick="editProblem('prob1')">Edit</button>
                            <button class="btn btn-outline" onclick="addImprovement('prob1')">Add Improvement</button>
                            <button class="btn btn-outline" onclick="addNote('prob1')">Add Note</button>
                        </div>
                    </div>

                    <div class="problem-card">
                        <div class="problem-header">
                            <h4>Digestive Issues</h4>
                            <div class="problem-meta">
                                <span class="severity moderate">Moderate</span>
                                <span class="status improving">Improving</span>
                                <span class="date">Reported: Nov 20, 2024</span>
                            </div>
                        </div>
                        <div class="problem-description">
                            <p>Irregular bowel movements, bloating, and occasional stomach cramps. Symptoms worsen with certain foods and stress.</p>
                        </div>
                        <div class="problem-notes">
                            <h5>Practitioner Notes:</h5>
                            <div class="note-item">
                                <p><strong>Dr. Rajesh Kumar - Dec 12, 2024:</strong> Virechana therapy showing positive results. Patient reports 70% improvement in symptoms.</p>
                            </div>
                        </div>
                        <div class="problem-actions">
                            <button class="btn btn-outline" onclick="editProblem('prob2')">Edit</button>
                            <button class="btn btn-outline" onclick="addImprovement('prob2')">Add Improvement</button>
                            <button class="btn btn-outline" onclick="addNote('prob2')">Add Note</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Improvements Tab -->
            <div class="tab-content" id="improvements">
                <div class="improvements-header">
                    <h3>Improvement Tracking</h3>
                    <button class="btn btn-primary" onclick="addNewImprovement()">
                        <i class="fas fa-plus"></i>
                        Record Improvement
                    </button>
                </div>
                <div class="improvements-list">
                    <div class="improvement-card">
                        <div class="improvement-header">
                            <h4>Back Pain Reduction</h4>
                            <div class="improvement-meta">
                                <span class="percentage">75%</span>
                                <span class="date">Recorded: Dec 15, 2024</span>
                            </div>
                        </div>
                        <div class="improvement-details">
                            <div class="measurement">
                                <span class="label">Pain Scale:</span>
                                <span class="before">8/10</span>
                                <i class="fas fa-arrow-right"></i>
                                <span class="after">5/10</span>
                            </div>
                            <div class="measurement">
                                <span class="label">Mobility:</span>
                                <span class="before">Limited</span>
                                <i class="fas fa-arrow-right"></i>
                                <span class="after">Good</span>
                            </div>
                            <div class="improvement-chart">
                                <canvas id="painChart"></canvas>
                            </div>
                        </div>
                        <div class="improvement-notes">
                            <p><strong>Notes:</strong> Significant improvement observed after 3 weeks of Basti therapy. Patient can now sit for longer periods without discomfort.</p>
                        </div>
                    </div>

                    <div class="improvement-card">
                        <div class="improvement-header">
                            <h4>Sleep Quality Enhancement</h4>
                            <div class="improvement-meta">
                                <span class="percentage">60%</span>
                                <span class="date">Recorded: Dec 10, 2024</span>
                            </div>
                        </div>
                        <div class="improvement-details">
                            <div class="measurement">
                                <span class="label">Sleep Hours:</span>
                                <span class="before">4-5 hours</span>
                                <i class="fas fa-arrow-right"></i>
                                <span class="after">6-7 hours</span>
                            </div>
                            <div class="measurement">
                                <span class="label">Sleep Quality:</span>
                                <span class="before">Poor</span>
                                <i class="fas fa-arrow-right"></i>
                                <span class="after">Good</span>
                            </div>
                        </div>
                        <div class="improvement-notes">
                            <p><strong>Notes:</strong> Nasya therapy and meditation practices have significantly improved sleep patterns.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vital Signs Tab -->
            <div class="tab-content" id="vitals">
                <div class="vitals-header">
                    <h3>Vital Signs History</h3>
                    <button class="btn btn-primary" onclick="addVitalSigns()">
                        <i class="fas fa-plus"></i>
                        Record Vitals
                    </button>
                </div>
                <div class="vitals-grid">
                    <div class="vital-card">
                        <h4>Blood Pressure</h4>
                        <div class="vital-chart">
                            <canvas id="bpChart"></canvas>
                        </div>
                        <div class="vital-current">
                            <span class="current-value">120/80</span>
                            <span class="current-label">mmHg</span>
                        </div>
                    </div>
                    <div class="vital-card">
                        <h4>Weight</h4>
                        <div class="vital-chart">
                            <canvas id="weightChart"></canvas>
                        </div>
                        <div class="vital-current">
                            <span class="current-value">65.2</span>
                            <span class="current-label">kg</span>
                        </div>
                    </div>
                    <div class="vital-card">
                        <h4>Heart Rate</h4>
                        <div class="vital-chart">
                            <canvas id="hrChart"></canvas>
                        </div>
                        <div class="vital-current">
                            <span class="current-value">72</span>
                            <span class="current-label">bpm</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Therapy Plan Tab -->
            <div class="tab-content" id="therapy">
                <div class="therapy-header">
                    <h3>Current Therapy Plan</h3>
                    <button class="btn btn-primary" onclick="updateTherapyPlan()">
                        <i class="fas fa-edit"></i>
                        Update Plan
                    </button>
                </div>
                <div class="therapy-plan">
                    <div class="therapy-card">
                        <h4>Basti Therapy</h4>
                        <div class="therapy-details">
                            <div class="detail-item">
                                <span class="label">Frequency:</span>
                                <span class="value">Daily</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Duration:</span>
                                <span class="value">30 minutes</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Practitioner:</span>
                                <span class="value">Dr. Rajesh Kumar</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Status:</span>
                                <span class="value status-active">Active</span>
                            </div>
                        </div>
                    </div>
                    <div class="therapy-card">
                        <h4>Dietary Guidelines</h4>
                        <div class="dietary-list">
                            <div class="dietary-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Warm, easily digestible foods</span>
                            </div>
                            <div class="dietary-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Avoid cold and processed foods</span>
                            </div>
                            <div class="dietary-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Include ghee and herbal teas</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div class="tab-content" id="notes">
                <div class="notes-header">
                    <h3>Patient Notes</h3>
                    <button class="btn btn-primary" onclick="addNewNote()">
                        <i class="fas fa-plus"></i>
                        Add Note
                    </button>
                </div>
                <div class="notes-list">
                    <div class="note-card">
                        <div class="note-header">
                            <h4>Progress Update</h4>
                            <div class="note-meta">
                                <span class="category general">General</span>
                                <span class="date">Dec 15, 2024</span>
                                <span class="author">Dr. Rajesh Kumar</span>
                            </div>
                        </div>
                        <div class="note-content">
                            <p>Patient showing excellent progress with current treatment plan. Pain levels have significantly reduced, and mobility has improved. Continue with Basti therapy for another week.</p>
                        </div>
                    </div>
                    <div class="note-card">
                        <div class="note-header">
                            <h4>Dietary Compliance</h4>
                            <div class="note-meta">
                                <span class="category treatment">Treatment</span>
                                <span class="date">Dec 12, 2024</span>
                                <span class="author">Dr. Priya Sharma</span>
                            </div>
                        </div>
                        <div class="note-content">
                            <p>Patient is following dietary guidelines well. No adverse reactions to prescribed herbs. Continue current diet plan.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>PanchakarmaPro</h3>
                    <p>Revolutionizing Ayurveda care with modern technology.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="patient-dashboard.html">Dashboard</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 PanchakarmaPro. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth-guard.js"></script> <!-- Ensure auth-guard is loaded -->
    <script>
        let currentUser = null;
        let currentPatientDetails = null;
        let patientIdFromUrl = null;

        // Check authentication and load data
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication and get user
            if (!window.authGuard.checkAuth()) {
                window.authGuard.redirectToLogin();
                return;
            }
            currentUser = window.authGuard.getUser();

            // Determine which patient's details to load
            const urlParams = new URLSearchParams(window.location.search);
            patientIdFromUrl = urlParams.get('patientId');

            if (currentUser.role === 'patient') {
                // If a patient is viewing their own details
                if (!patientIdFromUrl || patientIdFromUrl === currentUser._id) {
                    patientIdFromUrl = currentUser._id;
                } else {
                    // Patient trying to view another patient's details
                    window.PanchakarmaPro.showNotification('Access denied. You can only view your own details.', 'error');
                    window.location.href = 'patient-dashboard.html';
                    return;
                }
            } else if (currentUser.role === 'practitioner' || currentUser.role === 'admin') {
                // Practitioner or admin can view any patient's details, but patientId must be provided
                if (!patientIdFromUrl) {
                    window.PanchakarmaPro.showNotification('Patient ID is required to view details.', 'error');
                    window.location.href = 'practitioner-dashboard.html'; // Redirect to practitioner dashboard
                    return;
                }
            } else {
                // Other roles not allowed
                window.PanchakarmaPro.showNotification('Access denied. Insufficient permissions.', 'error');
                window.authGuard.redirectToLogin();
                return;
            }

            await loadPatientData(patientIdFromUrl);
            initializeCharts();
            setupEventListeners();
            switchTab('overview'); // Default to overview tab
        });

        function initializeCharts() {
            if (!currentPatientDetails) return;

            const dosha = currentPatientDetails.doshaAssessment;
            if (dosha) {
                const doshaCtx = document.getElementById('doshaChart').getContext('2d');
                new Chart(doshaCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Vata', 'Pitta', 'Kapha'],
                        datasets: [{
                            data: [dosha.vata, dosha.pitta, dosha.kapha],
                            backgroundColor: ['#8b5cf6', '#f59e0b', '#10b981'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            const vitalSigns = currentPatientDetails.vitalSigns;
            if (vitalSigns && vitalSigns.length > 0) {
                const labels = vitalSigns.map(v => new Date(v.date).toLocaleDateString()).reverse();
                const systolicData = vitalSigns.map(v => v.bloodPressure?.systolic).reverse();
                const diastolicData = vitalSigns.map(v => v.bloodPressure?.diastolic).reverse();
                const weightData = vitalSigns.map(v => v.weight).reverse();
                const heartRateData = vitalSigns.map(v => v.heartRate).reverse();

                // Vitals Chart (Combined)
                const vitalsCtx = document.getElementById('vitalsChart').getContext('2d');
                new Chart(vitalsCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Blood Pressure (Systolic)',
                            data: systolicData,
                            borderColor: '#dc2626',
                            tension: 0.4,
                            yAxisID: 'y-bp'
                        }, {
                            label: 'Blood Pressure (Diastolic)',
                            data: diastolicData,
                            borderColor: '#f59e0b',
                            tension: 0.4,
                            yAxisID: 'y-bp'
                        }, {
                            label: 'Weight (kg)',
                            data: weightData,
                            borderColor: '#10b981',
                            tension: 0.4,
                            yAxisID: 'y-weight'
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            'y-bp': {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Blood Pressure (mmHg)'
                                }
                            },
                            'y-weight': {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Weight (kg)'
                                },
                                grid: {
                                    drawOnChartArea: false, // only show grid lines for the first y-axis
                                },
                            }
                        }
                    }
                });

                // Individual Vital Charts (BP, Weight, HR)
                // BP Chart
                const bpCtx = document.getElementById('bpChart').getContext('2d');
                new Chart(bpCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Systolic',
                            data: systolicData,
                            borderColor: '#dc2626',
                            tension: 0.4
                        }, {
                            label: 'Diastolic',
                            data: diastolicData,
                            borderColor: '#059669',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });

                // Weight Chart
                const weightCtx = document.getElementById('weightChart').getContext('2d');
                new Chart(weightCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Weight (kg)',
                            data: weightData,
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });

                // Heart Rate Chart
                const hrCtx = document.getElementById('hrChart').getContext('2d');
                new Chart(hrCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Heart Rate (bpm)',
                            data: heartRateData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }

            const improvements = currentPatientDetails.improvements;
            if (improvements && improvements.length > 0) {
                // Pain Chart (example, assuming 'pain_scale' measurement type)
                const painImprovements = improvements.filter(imp => imp.measurementType === 'pain_scale');
                if (painImprovements.length > 0) {
                    const painLabels = painImprovements.map(imp => new Date(imp.recordedDate).toLocaleDateString()).reverse();
                    const painData = painImprovements.map(imp => imp.afterValue).reverse(); // Assuming afterValue is the pain score

                    const painCtx = document.getElementById('painChart').getContext('2d');
                    new Chart(painCtx, {
                        type: 'line',
                        data: {
                            labels: painLabels,
                            datasets: [{
                                label: 'Pain Level (1-10)',
                                data: painData,
                                borderColor: '#dc2626',
                                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 10
                                }
                            }
                        }
                    });
                }
            }
        }

        async function loadPatientData(patientId) {
            try {
                const response = await window.api.getPatientDetails(patientId);
                if (response.success) {
                    currentPatientDetails = response.data;
                    displayPatientDetails(currentPatientDetails);
                } else {
                    window.PanchakarmaPro.showNotification(response.message || 'Failed to load patient details', 'error');
                    // Redirect if patient details not found or access denied
                    if (currentUser.role === 'patient') {
                        window.location.href = 'patient-dashboard.html';
                    } else {
                        window.location.href = 'practitioner-dashboard.html';
                    }
                }
            } catch (error) {
                console.error('Error loading patient data:', error);
                window.PanchakarmaPro.showNotification('Failed to load patient data', 'error');
            }
        }

        function displayPatientDetails(patientDetails) {
            if (!patientDetails) return;

            // Update basic patient info
            document.getElementById('patientName').textContent = patientDetails.patientId.firstName + ' ' + patientDetails.patientId.lastName;
            document.getElementById('patientId').textContent = `Patient ID: P${patientDetails.patientId._id.slice(-6).toUpperCase()}`;
            document.getElementById('patientAge').textContent = calculateAge(patientDetails.personalInfo.dateOfBirth);
            document.getElementById('patientGender').textContent = patientDetails.personalInfo.gender;
            // document.getElementById('patientAvatar').src = patientDetails.patientId.profileImage || 'https://images.unsplash.com/photo-1494790108755-2616b612b786?ixlib=rb-4.0.3&auto=format&fit=crop&w=150&q=80';
            // document.getElementById('lastVisit').textContent = new Date(patientDetails.updatedAt).toLocaleDateString(); // Or from latest appointment

            // Display Problems
            const problemsListContainer = document.querySelector('#problems .problems-list');
            problemsListContainer.innerHTML = '';
            if (patientDetails.problems && patientDetails.problems.length > 0) {
                patientDetails.problems.forEach(problem => {
                    const problemCard = document.createElement('div');
                    problemCard.className = 'problem-card';
                    problemCard.innerHTML = `
                        <div class="problem-header">
                            <h4>${problem.title}</h4>
                            <div class="problem-meta">
                                <span class="severity ${problem.severity}">${problem.severity}</span>
                                <span class="status ${problem.status}">${problem.status}</span>
                                <span class="date">Reported: ${new Date(problem.reportedDate).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="problem-description">
                            <p>${problem.description}</p>
                        </div>
                        <div class="problem-notes">
                            <h5>Practitioner Notes:</h5>
                            ${problem.practitionerNotes.map(note => `
                                <div class="note-item">
                                    <p><strong>${note.practitionerId?.firstName || 'N/A'} ${note.practitionerId?.lastName || ''} - ${new Date(note.timestamp).toLocaleDateString()}:</strong> ${note.note}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="problem-actions">
                            <button class="btn btn-outline" onclick="editProblem('${problem.problemId}')">Edit</button>
                            <button class="btn btn-outline" onclick="addImprovement('${problem.problemId}')">Add Improvement</button>
                            <button class="btn btn-outline" onclick="addNoteToProblem('${problem.problemId}')">Add Note</button>
                        </div>
                    `;
                    problemsListContainer.appendChild(problemCard);
                });
            } else {
                problemsListContainer.innerHTML = '<p class="text-center">No problems recorded.</p>';
            }

            // Display Improvements
            const improvementsListContainer = document.querySelector('#improvements .improvements-list');
            improvementsListContainer.innerHTML = '';
            if (patientDetails.improvements && patientDetails.improvements.length > 0) {
                patientDetails.improvements.forEach(improvement => {
                    const improvementCard = document.createElement('div');
                    improvementCard.className = 'improvement-card';
                    improvementCard.innerHTML = `
                        <div class="improvement-header">
                            <h4>${improvement.title}</h4>
                            <div class="improvement-meta">
                                <span class="percentage">${improvement.improvementPercentage}%</span>
                                <span class="date">Recorded: ${new Date(improvement.recordedDate).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="improvement-details">
                            <div class="measurement">
                                <span class="label">${improvement.measurementType}:</span>
                                <span class="before">${improvement.beforeValue || 'N/A'} ${improvement.unit || ''}</span>
                                <i class="fas fa-arrow-right"></i>
                                <span class="after">${improvement.afterValue || 'N/A'} ${improvement.unit || ''}</span>
                            </div>
                            <div class="improvement-notes">
                                <p><strong>Notes:</strong> ${improvement.notes || 'N/A'}</p>
                            </div>
                        </div>
                    `;
                    improvementsListContainer.appendChild(improvementCard);
                });
            } else {
                improvementsListContainer.innerHTML = '<p class="text-center">No improvements recorded.</p>';
            }

            // Display Therapy Plan
            const therapyPlanContainer = document.querySelector('#therapy .therapy-plan');
            therapyPlanContainer.innerHTML = '';
            if (patientDetails.therapyPlan && patientDetails.therapyPlan.currentTherapies && patientDetails.therapyPlan.currentTherapies.length > 0) {
                patientDetails.therapyPlan.currentTherapies.forEach(therapy => {
                    const therapyCard = document.createElement('div');
                    therapyCard.className = 'therapy-card';
                    therapyCard.innerHTML = `
                        <h4>${therapy.therapyType}</h4>
                        <div class="therapy-details">
                            <div class="detail-item">
                                <span class="label">Start Date:</span>
                                <span class="value">${new Date(therapy.startDate).toLocaleDateString()}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">End Date:</span>
                                <span class="value">${therapy.endDate ? new Date(therapy.endDate).toLocaleDateString() : 'Ongoing'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Frequency:</span>
                                <span class="value">${therapy.frequency || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Practitioner:</span>
                                <span class="value">${therapy.practitionerId?.firstName || 'N/A'} ${therapy.practitionerId?.lastName || ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Status:</span>
                                <span class="value status-${therapy.status}">${therapy.status}</span>
                            </div>
                        </div>
                    `;
                    therapyPlanContainer.appendChild(therapyCard);
                });
            } else {
                therapyPlanContainer.innerHTML = '<p class="text-center">No therapy plan active.</p>';
            }

            // Display Notes
            const notesListContainer = document.querySelector('#notes .notes-list');
            notesListContainer.innerHTML = '';
            if (patientDetails.notes && patientDetails.notes.length > 0) {
                patientDetails.notes.forEach(note => {
                    const noteCard = document.createElement('div');
                    noteCard.className = 'note-card';
                    noteCard.innerHTML = `
                        <div class="note-header">
                            <h4>${note.category} Note</h4>
                            <div class="note-meta">
                                <span class="category ${note.category}">${note.category}</span>
                                <span class="date">${new Date(note.timestamp).toLocaleDateString()}</span>
                                <span class="author">${note.practitionerId?.firstName || 'N/A'} ${note.practitionerId?.lastName || ''}</span>
                            </div>
                        </div>
                        <div class="note-content">
                            <p>${note.note}</p>
                        </div>
                    `;
                    notesListContainer.appendChild(noteCard);
                });
            } else {
                notesListContainer.innerHTML = '<p class="text-center">No notes recorded.</p>';
            }
        }

        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'N/A';
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                switchTab(tab);
            });
        });

        function switchTab(tab) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab).classList.add('active');
        }

        // Action functions
        function editPatientInfo() {
            alert('Edit patient info functionality would open here.');
        }

        function addNewProblem() {
            alert('Add new problem form would open here.');
        }

        function addNewImprovement() {
            alert('Add new improvement form would open here.');
        }

        function addVitalSigns() {
            alert('Add vital signs form would open here.');
        }

        function updateTherapyPlan() {
            alert('Update therapy plan form would open here.');
        }

        function addNewNote() {
            alert('Add new note form would open here.');
        }

        function editProblem(problemId) {
            alert(`Edit problem ${problemId} form would open here.`);
        }

        function addImprovement(problemId) {
            alert(`Add improvement for problem ${problemId} form would open here.`);
        }

        function addNote(problemId) {
            alert(`Add note for problem ${problemId} form would open here.`);
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                window.PanchakarmaPro.switchTab(tab); // Use centralized switchTab
            });
        });

        function setupEventListeners() {
            // Attach event listeners to action buttons
            document.querySelector('.patient-actions .btn-outline').addEventListener('click', editPatientInfo);
            document.querySelector('.patient-actions .btn-primary').addEventListener('click', addNewProblem);
            document.querySelector('#problems .problems-header .btn-primary').addEventListener('click', addNewProblem);
            document.querySelector('#improvements .improvements-header .btn-primary').addEventListener('click', addNewImprovement);
            document.querySelector('#vitals .vitals-header .btn-primary').addEventListener('click', addVitalSigns);
            document.querySelector('#therapy .therapy-header .btn-primary').addEventListener('click', updateTherapyPlan);
            document.querySelector('#notes .notes-header .btn-primary').addEventListener('click', addNewNote);
        }

        // Action functions (will open modals/forms for input)
        function editPatientInfo() {
            window.PanchakarmaPro.showNotification('Edit patient info functionality would open here.', 'info');
            // Implement modal or redirect to a form for editing personalInfo and medicalHistory
        }

        async function addNewProblem() {
            window.PanchakarmaPro.showNotification('Add new problem form would open here.', 'info');
            // Example: open a modal with a form to add a new problem
            // For now, a simple prompt
            const title = prompt('Enter problem title:');
            const description = prompt('Enter problem description:');
            const severity = prompt('Enter severity (mild, moderate, severe):');

            if (title && description && severity) {
                try {
                    const response = await window.api.addPatientProblem(patientIdFromUrl, { title, description, severity });
                    if (response.success) {
                        window.PanchakarmaPro.showNotification('Problem added successfully!', 'success');
                        loadPatientData(patientIdFromUrl); // Refresh data
                    } else {
                        window.PanchakarmaPro.showNotification(response.message || 'Failed to add problem', 'error');
                    }
                } catch (error) {
                    console.error('Error adding problem:', error);
                    window.PanchakarmaPro.showNotification('Failed to add problem', 'error');
                }
            }
        }

        async function addNewImprovement() {
            window.PanchakarmaPro.showNotification('Add new improvement form would open here.', 'info');
            // Example: open a modal with a form to add a new improvement
            const problemId = prompt('Enter related problem ID:'); // Needs to be selected from existing problems
            const title = prompt('Enter improvement title:');
            const description = prompt('Enter improvement description:');
            const improvementPercentage = parseFloat(prompt('Enter improvement percentage (0-100):'));
            const measurementType = prompt('Enter measurement type (pain_scale, mobility, energy_level, sleep_quality, mood, other):');
            const beforeValue = prompt('Enter before value (optional):');
            const afterValue = prompt('Enter after value (optional):');
            const unit = prompt('Enter unit (optional):');
            const notes = prompt('Enter notes (optional):');

            if (problemId && title && description && !isNaN(improvementPercentage) && measurementType) {
                try {
                    const response = await window.api.addPatientImprovement(patientIdFromUrl, {
                        problemId, title, description, improvementPercentage, measurementType,
                        beforeValue, afterValue, unit, notes
                    });
                    if (response.success) {
                        window.PanchakarmaPro.showNotification('Improvement recorded successfully!', 'success');
                        loadPatientData(patientIdFromUrl); // Refresh data
                    } else {
                        window.PanchakarmaPro.showNotification(response.message || 'Failed to record improvement', 'error');
                    }
                } catch (error) {
                    console.error('Error adding improvement:', error);
                    window.PanchakarmaPro.showNotification('Failed to record improvement', 'error');
                }
            }
        }

        async function addVitalSigns() {
            window.PanchakarmaPro.showNotification('Add vital signs form would open here.', 'info');
            // Example: open a modal with a form to add vital signs
            const systolic = parseFloat(prompt('Enter systolic blood pressure:'));
            const diastolic = parseFloat(prompt('Enter diastolic blood pressure:'));
            const heartRate = parseFloat(prompt('Enter heart rate:'));
            const temperature = parseFloat(prompt('Enter temperature:'));
            const weight = parseFloat(prompt('Enter weight (kg):'));
            const height = parseFloat(prompt('Enter height (cm):'));

            const vitalSignsData = {};
            if (!isNaN(systolic) && !isNaN(diastolic)) vitalSignsData.bloodPressure = { systolic, diastolic };
            if (!isNaN(heartRate)) vitalSignsData.heartRate = heartRate;
            if (!isNaN(temperature)) vitalSignsData.temperature = temperature;
            if (!isNaN(weight)) vitalSignsData.weight = weight;
            if (!isNaN(height)) vitalSignsData.height = height;

            if (Object.keys(vitalSignsData).length > 0) {
                try {
                    const response = await window.api.addPatientVitalSigns(patientIdFromUrl, vitalSignsData);
                    if (response.success) {
                        window.PanchakarmaPro.showNotification('Vital signs recorded successfully!', 'success');
                        loadPatientData(patientIdFromUrl); // Refresh data
                    } else {
                        window.PanchakarmaPro.showNotification(response.message || 'Failed to record vital signs', 'error');
                    }
                } catch (error) {
                    console.error('Error adding vital signs:', error);
                    window.PanchakarmaPro.showNotification('Failed to record vital signs', 'error');
                }
            }
        }

        function updateTherapyPlan() {
            window.PanchakarmaPro.showNotification('Update therapy plan form would open here.', 'info');
            // Implement modal or redirect to a form for updating therapyPlan
        }

        async function addNewNote() {
            window.PanchakarmaPro.showNotification('Add new note form would open here.', 'info');
            const noteContent = prompt('Enter note content:');
            const category = prompt('Enter category (general, symptom, treatment, progress, concern):');
            const isPrivate = confirm('Is this note private?');

            if (noteContent && category) {
                try {
                    const response = await window.api.addPatientNote(patientIdFromUrl, {
                        note: noteContent,
                        category: category,
                        isPrivate: isPrivate,
                        practitionerId: currentUser._id // Assuming practitioner is adding the note
                    });
                    if (response.success) {
                        window.PanchakarmaPro.showNotification('Note added successfully!', 'success');
                        loadPatientData(patientIdFromUrl); // Refresh data
                    } else {
                        window.PanchakarmaPro.showNotification(response.message || 'Failed to add note', 'error');
                    }
                } catch (error) {
                    console.error('Error adding note:', error);
                    window.PanchakarmaPro.showNotification('Failed to add note', 'error');
                }
            }
        }

        function editProblem(problemId) {
            window.PanchakarmaPro.showNotification(`Edit problem ${problemId} functionality would open here.`, 'info');
            // Implement modal or redirect to a form for editing a specific problem
        }

        function addImprovement(problemId) {
            window.PanchakarmaPro.showNotification(`Add improvement for problem ${problemId} functionality would open here.`, 'info');
            // Implement modal or redirect to a form for adding improvement for a specific problem
        }

        function addNoteToProblem(problemId) {
            window.PanchakarmaPro.showNotification(`Add note for problem ${problemId} functionality would open here.`, 'info');
            // Implement modal or redirect to a form for adding a note to a specific problem
        }
    </script>
</body>
</html>
